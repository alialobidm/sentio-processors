import assert from 'assert'
import { TestProcessorServer } from '@sentio/sdk/testing'
import { before, describe, test } from 'node:test'
import { expect } from 'chai'
import { Log } from '@ethersproject/abstract-provider'


describe('Test Processor', () => {
  const service = new TestProcessorServer(()=>import('./processor.js'),  {
    1: "https://eth-mainnet.g.alchemy.com/v2/SAow9F_73wmx_Uj5yEcI_au8y9GXYYd5",
  })

  before(async () => {
    await service.start()
  })

  test('has config', async () => {
    const config = await service.getConfig({})
    expect(config.contractConfigs.length > 0)
  })

  test('test trace1', async () => {
    const traceStr = "{\"blockNumber\":13765014,\"result\":{\"gasUsed\":\"0x355\",\"output\":\"0x\"},\"subtraces\":0,\"transactionPosition\":13,\"action\":{\"callType\":\"call\",\"from\":\"0x72913a8b68e1d50b1f068b0c99eb463380c4dfbc\",\"gas\":\"0x91704\",\"init\":\"0x\",\"input\":\"0x52bbbe2900000000000000000000000000000000000000000000000000000000000000e000000000000000000000000072913a8b68e1d50b1f068b0c99eb463380c4dfbc000000000000000000000000000000000000000000000000000000000000000000000000000000000000000072913a8b68e1d50b1f068b0c99eb463380c4dfbc000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003635c9adc5dea000000000000000000000000000000000000000000000000000000000000061b0b6574ddf308520864ecfc759c49e72acfc96c023ed900002000000000000000000e10000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb4800000000000000000000000083e9f223e1edb3486f876ee888d76bfba26c475a000000000000000000000000000000000000000000000000000000007735940000000000000000000000000000000000000000000000000000000000000004a00000000000000000000000000000000000000000000000000000000000000000\",\"to\":\"0xba12222222228d8ba445958a75a0704d566bf2c8\",\"value\":\"0x0\"},\"blockHash\":\"0x166962819448c580c0d10874519b77a6a47ef97653681c2968824a379b0070db\",\"transactionHash\":\"0x847ddee3ed1623ea6ff153448b8422b793cc690a43cd0002621cc0ab613d2d9c\",\"type\":\"call\",\"error\":\"Reverted\",\"traceAddress\":[]}"

    // jest.setTimeout(100000)
    // const logStr = "{\"address\":\"0x0baba1ad5be3a5c0a66e7ac838a129bf948f1ea4\",\"topics\":[\"0x73ff7b101bcdc22f199e8e1dd9893170a683d6897be4f1086ca05705abb886ae\"],\"data\":\"0x0000000000000000000000007bc64c3adb29e12c209c94c02651efc806d527350000000000000000000000007bc64c3adb29e12c209c94c02651efc806d527350000000000000000000000009f8f72aa9304c8b593d555f12ef6589cc3a579a20000000000000000000000000000000000000000000000000000000000000007000000000000000000000000000000000000000000000003685c5979a98c0020\",\"blockNumber\":\"0xad6577\",\"transactionHash\":\"0xe04d6b4d4a22fbe11947699a59935a8419f50b0c55d32c0963fde34ba5c00976\",\"transactionIndex\":\"0x6a\",\"blockHash\":\"0x11a1bc99c917ec83474caef32118bdb7831b7a2743b35980271d9bc493103856\",\"logIndex\":\"0x9a\",\"removed\":false}\n"
    const res = await service.eth.testTrace(JSON.parse(traceStr))
    console.log(JSON.stringify(res))
  })
})
