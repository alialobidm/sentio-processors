import assert from 'assert'
import { TestProcessorServer } from '@sentio/sdk/testing'
import { before, describe, test } from 'node:test'
import { expect } from 'chai'
import { Log } from '@ethersproject/abstract-provider'


describe('Test Processor', () => {
  const service = new TestProcessorServer(()=>import('./processor.js'),  {
    1: "https://eth-mainnet.g.alchemy.com/v2/SAow9F_73wmx_Uj5yEcI_au8y9GXYYd5",
  })

  before(async () => {
    await service.start()
  })

  test('has config', async () => {
    const config = await service.getConfig({})
    expect(config.contractConfigs.length > 0)
  })

  test('test log', async () => {
    // jest.setTimeout(100000)
    // const logStr = "{\"address\":\"0x57e037f4d2c8bea011ad8a9a5af4aaeed508650f\",\"topics\":[\"0x5b03bfed1c14a02bdeceb5fa582eb1a5765fc0bc64ca0e6af4c20afc9487f081\"],\"data\":\"0x00000000000000000000000093269483a70c68d5c5bb63aac1e8f4ac59f498800000000000000000000000000c520e51c055cf63bab075715c1b860b2e9b8e24\",\"blockNumber\":\"0xc9d6d7\",\"transactionHash\":\"0x208af3250499672c2f07138b9aa236153c65c78ae4341b23c2763017afdd61a2\",\"transactionIndex\":\"0xf3\",\"blockHash\":\"0x6e3b100c34b510049e922fbe1c1dab1b0793be3d1229b632688e6a518cdd11b6\",\"logIndex\":\"0x14b\",\"removed\":false}"
    // const res = await service.testLog(JSON.parse(logStr))
    // console.log(JSON.stringify(res))
  })

  test('test log2', async () => {
    // jest.setTimeout(100000)
    const logStr = "{\"address\":\"0x0baba1ad5be3a5c0a66e7ac838a129bf948f1ea4\",\"topics\":[\"0x73ff7b101bcdc22f199e8e1dd9893170a683d6897be4f1086ca05705abb886ae\"],\"data\":\"0x0000000000000000000000007bc64c3adb29e12c209c94c02651efc806d527350000000000000000000000007bc64c3adb29e12c209c94c02651efc806d527350000000000000000000000009f8f72aa9304c8b593d555f12ef6589cc3a579a20000000000000000000000000000000000000000000000000000000000000007000000000000000000000000000000000000000000000003685c5979a98c0020\",\"blockNumber\":\"0xad6577\",\"transactionHash\":\"0xe04d6b4d4a22fbe11947699a59935a8419f50b0c55d32c0963fde34ba5c00976\",\"transactionIndex\":\"0x6a\",\"blockHash\":\"0x11a1bc99c917ec83474caef32118bdb7831b7a2743b35980271d9bc493103856\",\"logIndex\":\"0x9a\",\"removed\":false}\n"
    const res = await service.eth.testLog(JSON.parse(logStr))
    console.log(JSON.stringify(res))
  })

  test('test trace1', async () => {
    const traceStr = "{\"action\":{\"callType\":\"call\",\"from\":\"0x153cddd727e407cb951f728f24beb9a5faaa8512\",\"gas\":\"0x2bd41d\",\"input\":\"0x5322843000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000000f00000000000000000000000000000000000000000000000000000000000001e00909d049c34e1a30ec7a266b6d544abe383a0b6efe3ae81239269015b0130eb617e73a7715d8592faa02a68dc7b4eb0680ece49f27ec0b594be17276e682d88e03ece85f97c5d4901d12a5514daaa85c14f2b66ceb8bc0f1eff8427330ed9acd2544e0051a1b2f7bd66eaefb5b0b23c12febd8098dacca34bc7fd5e057f7cbfb29a6307a051083958bcc9e0b3916219ecdbe44d91060bec3476c84f3840f892c138ff19a2fc4c46328cca02226bc826518f54461be11376327174cab9211bbc820bb49dfb7fc7ba64327c5e6b873ff40064df3512a2a965dcc0535f5cd0da3572082bd0c94d7d8200728da0ddd69383a55180a801722ec5f2853beabc977c1c1000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000013800000000000000000000000000000000000000000000000000000000000001c6000000000000000000000000000000000000000000000000000000000000011620baba1ad5be3a5c0a66e7ac838a129bf948f1ea41733a3068b6b7954c31929ab5b6870b1ba21772fc4556ad566140eacca253a5c07e9c29e6fed4ff7365091398f94f25e17ef319dd30f19517eeea9cf49634072605c21cc0000000000070000271101681ce3ab803f70b70e4553038fb4bf40e7575be600006f330000000004000000160000285800006f3300000006000000486ba9807a13e00a0004000012da000020da000056f700000048000000a966d6748446a50a00040000014600002859000056f700000006004800007618f469195f0a000400000d94000020db0000635500000048000000a961d3538123ef0a000400000002000020dc00006cf100000048000000a9630d4081e7c10a000400000434000020dd000064a400000048000000a96a20248952b90a000400000436000020de000064a400000048000000a96b6d628a1e840a000400000438000020df000064a400000048000000a966745883f8b20a00040000043a000020e0000064a400000048000000a96eeb728c38270a00040000043c000020e1000064a400000048000000a9718b4390eab50a00018a2cf9d33785ae4a8a737bf071cfbdf3fa36af22000064a4000000000400000008000020e2000068af00000048000000a97186a090dfc30a0002008a2cf9d33785ae4a8a737bf071cfbdf3fa36af22000064a400a9000200d28dc62611c424c51a9d01c8b962eb02eaae9b2800002e1500000004000002440000285a00006355000000060048000072c3c364e8200a0004000003c6000020e3000063550000004800a900008bb6f66e880a0a00040000043e000020e4000064a400000048000000a96ab0988988330a000400001ef6000001f400005a3c000000260000002260e8aa81c8560a00040000024e0000285b00005a3c000000060048000079193b69e76c0a0004000000180000285c00006f3300000006000000485d35576b0d3f0a0004000002500000285d00005a3c00000006004800006cf1a460d7490a000400001ef80000035200005a3c000000390000000760e5525fa3330a000400001efa00002b3e00005a3c0000001a0000002e5ffe8a75fcd30a000400000082000001f500005a3c000000260022000083944861d0110a000400001efc000001f600005a3c000000260000002261d2d98396fc0a00015d125481f1f346b86f6a59429422713fa48bf50200006e590000000004000006fc000237880000276000000001000100008986a06c726e0a00040000073e0002378900002e150000000100010000917ed0745a22060001d28dc62611c424c51a9d01c8b962eb02eaae9b2800002e150001000004000007000002378a0000276000000001000100008e1a8071c5f30a0004000010f40002378b0000271200000001000100008186a0646e4a060004000010f60002378c0000271200000001000100008186a0646e42060004000010f80002378d0000271200000001000100008186a0646e3b060004000010fa0002378e0000271200000001000100008186a0646e34060004000010fc0002378f0000271200000001000100008186a0646e2c060004000010fe000237900000271200000001000100008186a0646e2506000400001100000237910000271200000001000100008186a0646e1e06000400001102000237920000271200000001000100008186a0646e1606000400001104000237930000271200000001000100008186a0646e0f06000400001106000237940000271200000001000100008186a0646e0806000400000702000237950000276000000001000100008fa1207236a60a000200e158cfb9a9845e0152929e33cd26705bef0ab6710000695800af00030000006f3300004cec00017b23280001000000000003000000000000030000004cec00006f3300017a06d700010000000007510000000000000300000029ab00004cec00017b26b10001000000000015000000000000030000004cec000029ab000179b20d0001000000000753000000000000040000016c0000080b00006b670000004f000000ae5dfa9d70d6d70a00040000016e0000080c00006b670000004f000000ae5d70d76fa11f0a0004000001720000080d00006b670000004f000000ae622e72730d3f0a000400001e380000f612000029600000000f000100037493e01215960a0004000011080000f613000027120000000f000100038186a01ef1bc0600040000110a0000f614000027120000000f000100038186a01ef0030600040000110c0000f615000027120000000f000100038186a01eee4b0600040000110e0000f616000027120000000f000100038186a01eec93060004000011100000f617000027120000000f000100038186a01eeadc060004000011120000f618000027120000000f000100038186a01ee926060004000011140000f619000027120000000f000100038186a01ee770060004000011160000f61a000027120000000f000100038186a01ee5bb06000400001e3a00023796000029600000000100010000860ec569c19b0a0004000007400002379700002e1500000001000100008b0bf670e20f060004000007420002379800002e1500000001000100008986a06c6bc0060004000007440002379900002e15000000010001000088fde86adf7b060004000007460002379a00002e15000000010001000088d6d86a6e3c0600000022002604f3b50000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000022b1c8c1227a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002a5a058fc295ed00000000a9897c000000436d75eabe94440e18d50bcdefa87a243c9cb75198000004c30c0dcb95f40000000070f00000019d7b96933344f2875ad9fc60aedb13e8a02f721331000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001f161421c8e0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000021dfd4150e82901c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001cc85402f0290000000af764000000001baab159d16f0f4c75c8e34b1629faf70148afb5e00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008c00000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000700000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000000000000000000000000000000000000000016000000000000000000000000000000000000000000000000000000000000001e000000000000000000000000000000000000000000000000000000000000003c000000000000000000000000000000000000000000000000000000000000005a0000000000000000000000000000000000000000000000000000000000000062000000000000000000000000000000000000000000000000000000000000006a00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000b000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000d00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000016000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000f2460000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000008a2cf9d33785ae4a8a737bf071cfbdf3fa36af2200000000000000000000000000000000000000000000000000000000000001200000000000000000000000000000000000000000000000020f5b1eaad8d800000000000000000000000000000000000000000000000000000000000060ab2dd900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000016000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000afc80000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000d7dfc0100734619f06c41ea68dd0147a91802480000000000000000000000000000000000000000000000000000000000000120000000000000000000000000000000000000000000000000005543df729c00000000000000000000000000000000000000000000000000000000000060ab1c0c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001d000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002a00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000016000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000f7a20000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000e158cfb9a9845e0152929e33cd26705bef0ab671000000000000000000000000000000000000000000000000000000000000012000000000000000000000000000000000000000000000000002386f26fc1000000000000000000000000000000000000000000000000000000000000060ab3144000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\",\"to\":\"0x0baba1ad5be3a5c0a66e7ac838a129bf948f1ea4\",\"value\":\"0x0\"},\"blockHash\":\"0xdeb1f94508d6d0506142378387e8179a789e263ec9bf2557dd45b827a2601bdb\",\"blockNumber\":12106291,\"result\":{\"gasUsed\":\"0x682ec\",\"output\":\"0x\"},\"subtraces\":1,\"traceAddress\":[0],\"transactionHash\":\"0x76aa3f9505f08d81a36a8db887f5a7a271f4a7df8f613efb9ef6e1157a8e2924\",\"transactionPosition\":66,\"type\":\"call\"}"
    // jest.setTimeout(100000)
    // const logStr = "{\"address\":\"0x0baba1ad5be3a5c0a66e7ac838a129bf948f1ea4\",\"topics\":[\"0x73ff7b101bcdc22f199e8e1dd9893170a683d6897be4f1086ca05705abb886ae\"],\"data\":\"0x0000000000000000000000007bc64c3adb29e12c209c94c02651efc806d527350000000000000000000000007bc64c3adb29e12c209c94c02651efc806d527350000000000000000000000009f8f72aa9304c8b593d555f12ef6589cc3a579a20000000000000000000000000000000000000000000000000000000000000007000000000000000000000000000000000000000000000003685c5979a98c0020\",\"blockNumber\":\"0xad6577\",\"transactionHash\":\"0xe04d6b4d4a22fbe11947699a59935a8419f50b0c55d32c0963fde34ba5c00976\",\"transactionIndex\":\"0x6a\",\"blockHash\":\"0x11a1bc99c917ec83474caef32118bdb7831b7a2743b35980271d9bc493103856\",\"logIndex\":\"0x9a\",\"removed\":false}\n"
    const res = await service.eth.testTrace(JSON.parse(traceStr))
    console.log(JSON.stringify(res))
  })



})
